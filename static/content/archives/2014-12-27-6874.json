{
  "categories": [
    "PHP"
  ],
  "date": "2014-12-27T11:59:28.000Z",
  "draft": false,
  "slug": 6874,
  "title": "PHP から Google Analytics API v3 を叩く",
  "bodyContent": "Google Analytics のデータ集計を自動でしたいので調べながら書いてみます。\n\n## 1. 新しいプロジェクトを作成する\n\n[Google Developers Console](https://cloud.google.com/console) 左メニュー「プロジェクト」から新規プロジェクトを作成します。ここでは適当なプロジェクト名「Analytics Project」を付けました。\n\n![](/images/2014/12/6874_1.png)\n\n## 2. API を有効化する\n\n「API と認証」内「API」から、今回使う Analytics API を選択します。その後の画面でスイッチをオンにします。\n\n![](/images/2014/12/6874_2.png)\n\n## 3. 認証情報\n\nOAuth 「新しいクライアント ID を作成」を選択します。アプリケーションの種類は、サービスアカウントを選択します。\n\n![](/images/2014/12/6874_3.png)\n\nその後、秘密キー（*.p12）がダウンロードされ、そのパスワードが表示されますので控えておきます。\n\n![](/images/2014/12/6874_4.png)\n\nサービスアカウントに紐付く、クライアント ID とメールアドレス、公開キーのフィンガープリント（CERTIFICATE FINGERPRINTS）も控えておきます。\n\n![](/images/2014/12/6874_5.png)\n\n## 4. 発行されたメールアドレスに Analytics の権限を付与する\n\n[Google Analytics](https://www.google.com/analytics/) に移動し、「アナリティクス設定」タブ → アカウント「ユーザー管理」から、先程発行されたメールアドレスが Analytics を見れるように、権限を付与しておきます。\n\n![](/images/2014/12/6874_6.png)\n\n## 5. ビュー ID を取得する\n\n権限を付与したアカウントに紐付く、プロパティに紐付く、ビューの ID を取得します。こちらを控えておきます。\n\n![](/images/2014/12/6874_7.png)\n\n## 6. Googel APIs を叩くクライアントライブラリをダウンロード\n\nGitHub から、クライアントライブラリをダウンロードします。\n\n[https://github.com/google/google-api-php-client](https://github.com/google/google-api-php-client)\n\n## 7. PHP から Google Analytics API v3 を叩く\n\n先程、ダウンロードしたライブラリを使って、Analytics API を叩いてみます。定数と `viewId` は、自身の環境のものに変えます。\n\n```\n<?php\n\nrequire_once(dirname(__FILE__) . '/google-api-php-client/autoload.php');\n\ndefine('APPLICATION_NAME', '*');\ndefine('SERVICE_ACCOUNT_NAME', '*@developer.gserviceaccount.com');\ndefine('KEY_PATH', dirname(__FILE__) . '/p12/*.p12');\ndate_default_timezone_set('Asia/Tokyo');\n\nclass Analytics {\n\n  private $service;\n\n  function __construct($applicationName, $serviceAccountName, $keyPath) {\n    $creds = new Google_Auth_AssertionCredentials(\n      $serviceAccountName,\n      array('https://www.googleapis.com/auth/analytics'),\n      file_get_contents($keyPath)\n    );\n\n    $client = new Google_Client();\n    $client->setApplicationName($applicationName);\n    $client->setAssertionCredentials($creds);\n    $this->service = new Google_Service_Analytics($client);\n  }\n\n  function getReport($viewId, $startDate, $endDate) {\n    $result = $this->service->data_ga->get(\n      'ga:' . $viewId,\n      $startDate,\n      $endDate,\n      'ga:pageviews,ga:users'\n    );\n\n    return $result['rows'];\n  }\n}\n\n$analytics = new Analytics(APPLICATION_NAME, SERVICE_ACCOUNT_NAME, KEY_PATH);\n$viewId = '*';\n$yesterday = date('Y-m-d', strtotime('-1 day'));\nvar_dump($analytics->getReport($viewId, $yesterday, $yesterday));\n```\n\n実行結果は、こんな感じです。昨日一日分のページビューとユーザ数が取得出来ました。\n\n```\n$ php analytics.php \narray(1) {\n  [0]=>\n  array(3) {\n    [0]=>\n    string(4) \"1091\"\n    [1]=>\n    string(3) \"870\"\n  }\n}\n```\n\n## 参考\n\n* [Google Analytics API v3をPHPから利用する方法](http://www.karakaram.com/google-analytics-api-batch)\n* [Core Reporting API - Segments](https://developers.google.com/analytics/devguides/reporting/core/v3/segments)",
  "bodyHtml": "<p>Google Analytics のデータ集計を自動でしたいので調べながら書いてみます。</p>\n<h2>1. 新しいプロジェクトを作成する</h2>\n<p><a href=\"https://cloud.google.com/console\">Google Developers Console</a> 左メニュー「プロジェクト」から新規プロジェクトを作成します。ここでは適当なプロジェクト名「Analytics Project」を付けました。</p>\n<p><img src=\"/images/2014/12/6874_1.png\" alt=\"\"></p>\n<h2>2. API を有効化する</h2>\n<p>「API と認証」内「API」から、今回使う Analytics API を選択します。その後の画面でスイッチをオンにします。</p>\n<p><img src=\"/images/2014/12/6874_2.png\" alt=\"\"></p>\n<h2>3. 認証情報</h2>\n<p>OAuth 「新しいクライアント ID を作成」を選択します。アプリケーションの種類は、サービスアカウントを選択します。</p>\n<p><img src=\"/images/2014/12/6874_3.png\" alt=\"\"></p>\n<p>その後、秘密キー（*.p12）がダウンロードされ、そのパスワードが表示されますので控えておきます。</p>\n<p><img src=\"/images/2014/12/6874_4.png\" alt=\"\"></p>\n<p>サービスアカウントに紐付く、クライアント ID とメールアドレス、公開キーのフィンガープリント（CERTIFICATE FINGERPRINTS）も控えておきます。</p>\n<p><img src=\"/images/2014/12/6874_5.png\" alt=\"\"></p>\n<h2>4. 発行されたメールアドレスに Analytics の権限を付与する</h2>\n<p><a href=\"https://www.google.com/analytics/\">Google Analytics</a> に移動し、「アナリティクス設定」タブ → アカウント「ユーザー管理」から、先程発行されたメールアドレスが Analytics を見れるように、権限を付与しておきます。</p>\n<p><img src=\"/images/2014/12/6874_6.png\" alt=\"\"></p>\n<h2>5. ビュー ID を取得する</h2>\n<p>権限を付与したアカウントに紐付く、プロパティに紐付く、ビューの ID を取得します。こちらを控えておきます。</p>\n<p><img src=\"/images/2014/12/6874_7.png\" alt=\"\"></p>\n<h2>6. Googel APIs を叩くクライアントライブラリをダウンロード</h2>\n<p>GitHub から、クライアントライブラリをダウンロードします。</p>\n<p><a href=\"https://github.com/google/google-api-php-client\">https://github.com/google/google-api-php-client</a></p>\n<h2>7. PHP から Google Analytics API v3 を叩く</h2>\n<p>先程、ダウンロードしたライブラリを使って、Analytics API を叩いてみます。定数と <code>viewId</code> は、自身の環境のものに変えます。</p>\n<pre><code>&lt;?php\n\nrequire_once(dirname(__FILE__) . '/google-api-php-client/autoload.php');\n\ndefine('APPLICATION_NAME', '*');\ndefine('SERVICE_ACCOUNT_NAME', '*@developer.gserviceaccount.com');\ndefine('KEY_PATH', dirname(__FILE__) . '/p12/*.p12');\ndate_default_timezone_set('Asia/Tokyo');\n\nclass Analytics {\n\n  private $service;\n\n  function __construct($applicationName, $serviceAccountName, $keyPath) {\n    $creds = new Google_Auth_AssertionCredentials(\n      $serviceAccountName,\n      array('https://www.googleapis.com/auth/analytics'),\n      file_get_contents($keyPath)\n    );\n\n    $client = new Google_Client();\n    $client-&gt;setApplicationName($applicationName);\n    $client-&gt;setAssertionCredentials($creds);\n    $this-&gt;service = new Google_Service_Analytics($client);\n  }\n\n  function getReport($viewId, $startDate, $endDate) {\n    $result = $this-&gt;service-&gt;data_ga-&gt;get(\n      'ga:' . $viewId,\n      $startDate,\n      $endDate,\n      'ga:pageviews,ga:users'\n    );\n\n    return $result['rows'];\n  }\n}\n\n$analytics = new Analytics(APPLICATION_NAME, SERVICE_ACCOUNT_NAME, KEY_PATH);\n$viewId = '*';\n$yesterday = date('Y-m-d', strtotime('-1 day'));\nvar_dump($analytics-&gt;getReport($viewId, $yesterday, $yesterday));\n</code></pre>\n<p>実行結果は、こんな感じです。昨日一日分のページビューとユーザ数が取得出来ました。</p>\n<pre><code>$ php analytics.php \narray(1) {\n  [0]=&gt;\n  array(3) {\n    [0]=&gt;\n    string(4) &quot;1091&quot;\n    [1]=&gt;\n    string(3) &quot;870&quot;\n  }\n}\n</code></pre>\n<h2>参考</h2>\n<ul>\n<li><a href=\"http://www.karakaram.com/google-analytics-api-batch\">Google Analytics API v3をPHPから利用する方法</a></li>\n<li><a href=\"https://developers.google.com/analytics/devguides/reporting/core/v3/segments\">Core Reporting API - Segments</a></li>\n</ul>\n",
  "dir": "static/content/archives",
  "base": "2014-12-27-6874.json",
  "ext": ".json",
  "sourceBase": "2014-12-27-6874.md",
  "sourceExt": ".md"
}